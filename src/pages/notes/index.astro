---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NoteCard from "../../components/NoteCard.astro";
import { getCollection } from "astro:content";

const notes = (await getCollection("notes", ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Group notes by topic
const topics = [...new Set(notes.map((n) => n.data.topic).filter(Boolean))];
---

<BaseLayout title="Notes" description="Short-form notes and learning updates.">
  <section class="max-w-4xl mx-auto px-4 py-16">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">Notes</h1>
    <p class="text-xl text-gray-600 dark:text-gray-400 mb-8 max-w-2xl">
      Quick notes, TILs, and things I'm learning. Less polished, more frequent.
    </p>

    {topics.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8" id="topic-filters">
        <button
          data-topic="all"
          class="topic-btn px-3 py-1 text-sm font-medium rounded-full transition-colors bg-primary-600 text-white"
        >
          All
        </button>
        {topics.map((topic) => (
          <button
            data-topic={topic}
            class="topic-btn px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 text-sm font-medium rounded-full transition-colors hover:bg-primary-200 dark:hover:bg-primary-800"
          >
            {topic}
          </button>
        ))}
      </div>
    )}

    <div class="grid gap-4" id="notes-grid">
      {notes.map((note) => (
        <div class="note-item" data-topic={note.data.topic || ""}>
          <NoteCard
            title={note.data.title}
            date={note.data.date}
            slug={note.slug}
            topic={note.data.topic}
          />
        </div>
      ))}
    </div>

    {notes.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">No notes yet. Check back soon!</p>
      </div>
    )}
  </section>
</BaseLayout>

<script>
  function initTopicFilter() {
    const buttons = document.querySelectorAll('.topic-btn');
    const noteItems = document.querySelectorAll('.note-item');

    function applyFilter(topic: string) {
      // Update button styles
      buttons.forEach(b => {
        b.classList.remove('bg-primary-600', 'text-white');
        b.classList.add('bg-primary-100', 'dark:bg-primary-900', 'text-primary-700', 'dark:text-primary-300');
        if (b.getAttribute('data-topic') === topic) {
          b.classList.remove('bg-primary-100', 'dark:bg-primary-900', 'text-primary-700', 'dark:text-primary-300');
          b.classList.add('bg-primary-600', 'text-white');
        }
      });

      // Filter notes
      noteItems.forEach(item => {
        const itemTopic = item.getAttribute('data-topic');
        if (topic === 'all' || itemTopic === topic) {
          (item as HTMLElement).style.display = 'block';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });

      // Update URL without reload
      const url = new URL(window.location.href);
      if (topic === 'all') {
        url.searchParams.delete('topic');
      } else {
        url.searchParams.set('topic', topic);
      }
      window.history.replaceState({}, '', url.toString());
    }

    // Check URL for initial filter
    const urlParams = new URLSearchParams(window.location.search);
    const initialTopic = urlParams.get('topic') || 'all';
    applyFilter(initialTopic);

    // Add click handlers
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const topic = btn.getAttribute('data-topic') || 'all';
        applyFilter(topic);
      });
    });
  }

  // Run on initial load
  initTopicFilter();

  // Re-run on Astro page transitions
  document.addEventListener('astro:after-swap', initTopicFilter);
</script>